"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WatchLambdaFunction = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const cloudwatch = require("aws-cdk-lib/aws-cloudwatch");
const constructs_1 = require("constructs");
const metrics_1 = require("./monitoring/aws/lambda/metrics");
const DEFAULT_DURATION_THRESHOLD_PERCENT = 80;
class WatchLambdaFunction extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const cfnFunction = props.fn.node.defaultChild;
        const timeoutSec = cfnFunction.timeout || 3;
        this.watchful = props.watchful;
        this.fn = props.fn;
        this.metrics = new metrics_1.LambdaMetricFactory();
        this.watchful.addSection(props.title, {
            links: [
                { title: 'AWS Lambda Console', url: linkForLambdaFunction(this.fn) },
                { title: 'CloudWatch Logs', url: linkForLambdaLogs(this.fn) },
            ],
        });
        const { errorsMetric, errorsAlarm } = this.createErrorsMonitor(props.errorsPerMinuteThreshold, props.evaluationPeriods);
        const { throttlesMetric, throttlesAlarm } = this.createThrottlesMonitor(props.throttlesPerMinuteThreshold, props.evaluationPeriods);
        const { durationMetric, durationAlarm } = this.createDurationMonitor(timeoutSec, props.durationThresholdPercent, props.evaluationPeriods);
        const invocationsMetric = this.metrics.metricInvocations(this.fn.functionName);
        this.watchful.addWidgets(new cloudwatch.GraphWidget({
            title: `Invocations/${invocationsMetric.period.toMinutes()}min`,
            width: 6,
            left: [invocationsMetric],
        }), new cloudwatch.GraphWidget({
            title: `Errors/${errorsMetric.period.toMinutes()}min`,
            width: 6,
            left: [errorsMetric],
            leftAnnotations: [errorsAlarm.toAnnotation()],
        }), new cloudwatch.GraphWidget({
            title: `Throttles/${throttlesMetric.period.toMinutes()}min`,
            width: 6,
            left: [throttlesMetric],
            leftAnnotations: [throttlesAlarm.toAnnotation()],
        }), new cloudwatch.GraphWidget({
            title: `Duration/${durationMetric.period.toMinutes()}min`,
            width: 6,
            left: [durationMetric],
            leftAnnotations: [durationAlarm.toAnnotation()],
        }));
    }
    createErrorsMonitor(errorsPerMinuteThreshold = 0, evaluationPeriods = 3) {
        const fn = this.fn;
        const errorsMetric = this.metrics.metricErrors(fn.functionName);
        const errorsAlarm = errorsMetric.createAlarm(this, 'ErrorsAlarm', {
            alarmDescription: `Over ${errorsPerMinuteThreshold} errors per minute`,
            threshold: errorsPerMinuteThreshold,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            evaluationPeriods,
        });
        this.watchful.addAlarm(errorsAlarm);
        return { errorsMetric, errorsAlarm };
    }
    createThrottlesMonitor(throttlesPerMinuteThreshold = 0, evaluationPeriods = 3) {
        const fn = this.fn;
        const throttlesMetric = this.metrics.metricThrottles(fn.functionName);
        const throttlesAlarm = throttlesMetric.createAlarm(this, 'ThrottlesAlarm', {
            alarmDescription: `Over ${throttlesPerMinuteThreshold} throttles per minute`,
            threshold: throttlesPerMinuteThreshold,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            evaluationPeriods,
        });
        this.watchful.addAlarm(throttlesAlarm);
        return { throttlesMetric, throttlesAlarm };
    }
    createDurationMonitor(timeoutSec, durationPercentThreshold = DEFAULT_DURATION_THRESHOLD_PERCENT, evaluationPeriods = 3) {
        const fn = this.fn;
        const durationMetric = this.metrics.metricDuration(fn.functionName).p99;
        const durationThresholdSec = Math.floor((durationPercentThreshold / 100) * timeoutSec);
        const durationAlarm = durationMetric.createAlarm(this, 'DurationAlarm', {
            alarmDescription: `p99 latency >= ${durationThresholdSec}s (${durationPercentThreshold}%)`,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            threshold: durationThresholdSec * 1000,
            evaluationPeriods,
        });
        this.watchful.addAlarm(durationAlarm);
        return { durationMetric, durationAlarm };
    }
}
exports.WatchLambdaFunction = WatchLambdaFunction;
_a = JSII_RTTI_SYMBOL_1;
WatchLambdaFunction[_a] = { fqn: "cdk-watchful.WatchLambdaFunction", version: "0.0.0" };
function linkForLambdaFunction(fn, tab = 'graph') {
    return `https://console.aws.amazon.com/lambda/home?region=${fn.stack.region}#/functions/${fn.functionName}?tab=${tab}`;
}
function linkForLambdaLogs(fn) {
    return `https://console.aws.amazon.com/cloudwatch/home?region=${fn.stack.region}#logEventViewer:group=/aws/lambda/${fn.functionName}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlEQUF5RDtBQUV6RCwyQ0FBdUM7QUFFdkMsNkRBQXNFO0FBRXRFLE1BQU0sa0NBQWtDLEdBQUcsRUFBRSxDQUFDO0FBMEM5QyxNQUFhLG1CQUFvQixTQUFRLHNCQUFTO0lBS2hELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBK0I7UUFDdkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFrQyxDQUFDO1FBQ3JFLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDO1FBRTVDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLDZCQUFtQixFQUFFLENBQUM7UUFFekMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRTtZQUNwQyxLQUFLLEVBQUU7Z0JBQ0wsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDcEUsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTthQUM5RDtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUM1RCxLQUFLLENBQUMsd0JBQXdCLEVBQzlCLEtBQUssQ0FBQyxpQkFBaUIsQ0FD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QUFTLHFCQUFxQixDQUFDLEVBQW1CLEVBQUUsR0FBRyxHQUFHLE9BQU87SUFDL0QsT0FBTyxxREFBcUQsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLGVBQWUsRUFBRSxDQUFDLFlBQVksUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUN6SCxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxFQUFtQjtJQUM1QyxPQUFPLHlEQUF5RCxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0scUNBQXFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUN4SSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2xvdWR3YXRjaCBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2xvdWR3YXRjaCc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IElXYXRjaGZ1bCB9IGZyb20gJy4vYXBpJztcbmltcG9ydCB7IExhbWJkYU1ldHJpY0ZhY3RvcnkgfSBmcm9tICcuL21vbml0b3JpbmcvYXdzL2xhbWJkYS9tZXRyaWNzJztcblxuY29uc3QgREVGQVVMVF9EVVJBVElPTl9USFJFU0hPTERfUEVSQ0VOVCA9IDgwO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoTGFtYmRhRnVuY3Rpb25PcHRpb25zIHtcbiAgLyoqXG4gICAqIE51bWJlciBvZiBhbGxvd2VkIGVycm9ycyBwZXIgbWludXRlLiBJZiB0aGVyZSBhcmUgbW9yZSBlcnJvcnMgdGhhbiB0aGF0LCBhbiBhbGFybSB3aWxsIHRyaWdnZXIuXG4gICAqXG4gICAqIEBkZWZhdWx0IDBcbiAgICovXG4gIHJlYWRvbmx5IGVycm9yc1Blck1pbnV0ZVRocmVzaG9sZD86IG51bWJlcjtcblxuICAvKipcbiAgICogTnVtYmVyIG9mIGFsbG93ZWQgdGhyb3R0bGVzIHBlciBtaW51dGUuXG4gICAqXG4gICAqIEBkZWZhdWx0IDBcbiAgICovXG4gIHJlYWRvbmx5IHRocm90dGxlc1Blck1pbnV0ZVRocmVzaG9sZD86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhyZXNob2xkIGZvciB0aGUgZHVyYXRpb24gYWxhcm0gYXMgcGVyY2VudGFnZSBvZiB0aGUgZnVuY3Rpb24ncyB0aW1lb3V0XG4gICAqIHZhbHVlLlxuICAgKlxuICAgKiBJZiB0aGlzIGlzIHNldCB0byA1MCUsIHRoZSBhbGFybSB3aWxsIGJlIHNldCB3aGVuIHA5OSBsYXRlbmN5IG9mIHRoZVxuICAgKiBmdW5jdGlvbiBleGNlZWRzIDUwJSBvZiB0aGUgZnVuY3Rpb24ncyB0aW1lb3V0IHNldHRpbmcuXG4gICAqXG4gICAqIEBkZWZhdWx0IDgwXG4gICAqL1xuICByZWFkb25seSBkdXJhdGlvblRocmVzaG9sZFBlcmNlbnQ/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIE51bWJlciBvZiBwZXJpb2RzIHRvIGV2YWx1YXRlIGZvciB0aGUgYWxhcm1zLlxuICAgKlxuICAgKiBAZGVmYXVsdCAzXG4gICAqL1xuICByZWFkb25seSBldmFsdWF0aW9uUGVyaW9kcz86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXYXRjaExhbWJkYUZ1bmN0aW9uUHJvcHMgZXh0ZW5kcyBXYXRjaExhbWJkYUZ1bmN0aW9uT3B0aW9ucyB7XG4gIHJlYWRvbmx5IHRpdGxlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHdhdGNoZnVsOiBJV2F0Y2hmdWw7XG4gIHJlYWRvbmx5IGZuOiBsYW1iZGEuRnVuY3Rpb247XG59XG5cbmV4cG9ydCBjbGFzcyBXYXRjaExhbWJkYUZ1bmN0aW9uIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHJpdmF0ZSByZWFkb25seSB3YXRjaGZ1bDogSVdhdGNoZnVsO1xuICBwcml2YXRlIHJlYWRvbmx5IGZuOiBsYW1iZGEuRnVuY3Rpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0cmljczogTGFtYmRhTWV0cmljRmFjdG9yeTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogV2F0Y2hMYW1iZGFGdW5jdGlvblByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGNmbkZ1bmN0aW9uID0gcHJvcHMuZm4ubm9kZS5kZWZhdWx0Q2hpbGQgYXMgbGFtYmRhLkNmbkZ1bmN0aW9uO1xuICAgIGNvbnN0IHRpbWVvdXRTZWMgPSBjZm5GdW5jdGlvbi50aW1lb3V0IHx8IDM7XG5cbiAgICB0aGlzLndhdGNoZnVsID0gcHJvcHMud2F0Y2hmdWw7XG4gICAgdGhpcy5mbiA9IHByb3BzLmZuO1xuICAgIHRoaXMubWV0cmljcyA9IG5ldyBMYW1iZGFNZXRyaWNGYWN0b3J5KCk7XG5cbiAgICB0aGlzLndhdGNoZnVsLmFkZFNlY3Rpb24ocHJvcHMudGl0bGUsIHtcbiAgICAgIGxpbmtzOiBbXG4gICAgICAgIHsgdGl0bGU6ICdBV1MgTGFtYmRhIENvbnNvbGUnLCB1cmw6IGxpbmtGb3JMYW1iZGFGdW5jdGlvbih0aGlzLmZuKSB9LFxuICAgICAgICB7IHRpdGxlOiAnQ2xvdWRXYXRjaCBMb2dzJywgdXJsOiBsaW5rRm9yTGFtYmRhTG9ncyh0aGlzLmZuKSB9LFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHsgZXJyb3JzTWV0cmljLCBlcnJvcnNBbGFybSB9ID0gdGhpcy5jcmVhdGVFcnJvcnNNb25pdG9yKFxuICAgICAgcHJvcHMuZXJyb3JzUGVyTWludXRlVGhyZXNob2xkLFxuICAgICAgcHJvcHMuZXZhbHVhdGlvblBlcmlvZHMsXG4gICAgKTtcbiAgICBjb25zdCB7IHRocm90dGxlc01ldHJpYywgdGhyb3R0bGVzQWxhcm0gfSA9IHRoaXMuY3JlYXRlVGhyb3R0bGVzTW9uaXRvcihcbiAgICAgIHByb3BzLnRocm90dGxlc1Blck1pbnV0ZVRocmVzaG9sZCxcbiAgICAgIHByb3BzLmV2YWx1YXRpb25QZXJpb2RzLFxuICAgICk7XG4gICAgY29uc3QgeyBkdXJhdGlvbk1ldHJpYywgZHVyYXRpb25BbGFybSB9ID0gdGhpcy5jcmVhdGVEdXJhdGlvbk1vbml0b3IoXG4gICAgICB0aW1lb3V0U2VjLFxuICAgICAgcHJvcHMuZHVyYXRpb25UaHJlc2hvbGRQZXJjZW50LFxuICAgICAgcHJvcHMuZXZhbHVhdGlvblBlcmlvZHMsXG4gICAgKTtcbiAgICBjb25zdCBpbnZvY2F0aW9uc01ldHJpYyA9IHRoaXMubWV0cmljcy5tZXRyaWNJbnZvY2F0aW9ucyhcbiAgICAgIHRoaXMuZm4uZnVuY3Rpb25OYW1lLFxuICAgICk7XG5cbiAgICB0aGlzLndhdGNoZnVsLmFkZFdpZGdldHMoXG4gICAgICBuZXcgY2xvdWR3YXRjaC5HcmFwaFdpZGdldCh7XG4gICAgICAgIHRpdGxlOiBgSW52b2NhdGlvbnMvJHtpbnZvY2F0aW9uc01ldHJpYy5wZXJpb2QudG9NaW51dGVzKCl9bWluYCxcbiAgICAgICAgd2lkdGg6IDYsXG4gICAgICAgIGxlZnQ6IFtpbnZvY2F0aW9uc01ldHJpY10sXG4gICAgICB9KSxcbiAgICAgIG5ldyBjbG91ZHdhdGNoLkdyYXBoV2lkZ2V0KHtcbiAgICAgICAgdGl0bGU6IGBFcnJvcnMvJHtlcnJvcnNNZXRyaWMucGVyaW9kLnRvTWludXRlcygpfW1pbmAsXG4gICAgICAgIHdpZHRoOiA2LFxuICAgICAgICBsZWZ0OiBbZXJyb3JzTWV0cmljXSxcbiAgICAgICAgbGVmdEFubm90YXRpb25zOiBbZXJyb3JzQWxhcm0udG9Bbm5vdGF0aW9uKCldLFxuICAgICAgfSksXG4gICAgICBuZXcgY2xvdWR3YXRjaC5HcmFwaFdpZGdldCh7XG4gICAgICAgIHRpdGxlOiBgVGhyb3R0bGVzLyR7dGhyb3R0bGVzTWV0cmljLnBlcmlvZC50b01pbnV0ZXMoKX1taW5gLFxuICAgICAgICB3aWR0aDogNixcbiAgICAgICAgbGVmdDogW3Rocm90dGxlc01ldHJpY10sXG4gICAgICAgIGxlZnRBbm5vdGF0aW9uczogW3Rocm90dGxlc0FsYXJtLnRvQW5ub3RhdGlvbigpXSxcbiAgICAgIH0pLFxuICAgICAgbmV3IGNsb3Vkd2F0Y2guR3JhcGhXaWRnZXQoe1xuICAgICAgICB0aXRsZTogYER1cmF0aW9uLyR7ZHVyYXRpb25NZXRyaWMucGVyaW9kLnRvTWludXRlcygpfW1pbmAsXG4gICAgICAgIHdpZHRoOiA2LFxuICAgICAgICBsZWZ0OiBbZHVyYXRpb25NZXRyaWNdLFxuICAgICAgICBsZWZ0QW5ub3RhdGlvbnM6IFtkdXJhdGlvbkFsYXJtLnRvQW5ub3RhdGlvbigpXSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVycm9yc01vbml0b3IoXG4gICAgZXJyb3JzUGVyTWludXRlVGhyZXNob2xkID0gMCxcbiAgICBldmFsdWF0aW9uUGVyaW9kcyA9IDMsXG4gICkge1xuICAgIGNvbnN0IGZuID0gdGhpcy5mbjtcbiAgICBjb25zdCBlcnJvcnNNZXRyaWMgPSB0aGlzLm1ldHJpY3MubWV0cmljRXJyb3JzKGZuLmZ1bmN0aW9uTmFtZSk7XG4gICAgY29uc3QgZXJyb3JzQWxhcm0gPSBlcnJvcnNNZXRyaWMuY3JlYXRlQWxhcm0odGhpcywgJ0Vycm9yc0FsYXJtJywge1xuICAgICAgYWxhcm1EZXNjcmlwdGlvbjogYE92ZXIgJHtlcnJvcnNQZXJNaW51dGVUaHJlc2hvbGR9IGVycm9ycyBwZXIgbWludXRlYCxcbiAgICAgIHRocmVzaG9sZDogZXJyb3JzUGVyTWludXRlVGhyZXNob2xkLFxuICAgICAgY29tcGFyaXNvbk9wZXJhdG9yOiBjbG91ZHdhdGNoLkNvbXBhcmlzb25PcGVyYXRvci5HUkVBVEVSX1RIQU5fVEhSRVNIT0xELFxuICAgICAgZXZhbHVhdGlvblBlcmlvZHMsXG4gICAgfSk7XG4gICAgdGhpcy53YXRjaGZ1bC5hZGRBbGFybShlcnJvcnNBbGFybSk7XG4gICAgcmV0dXJuIHsgZXJyb3JzTWV0cmljLCBlcnJvcnNBbGFybSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVUaHJvdHRsZXNNb25pdG9yKFxuICAgIHRocm90dGxlc1Blck1pbnV0ZVRocmVzaG9sZCA9IDAsXG4gICAgZXZhbHVhdGlvblBlcmlvZHMgPSAzLFxuICApIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZm47XG4gICAgY29uc3QgdGhyb3R0bGVzTWV0cmljID0gdGhpcy5tZXRyaWNzLm1ldHJpY1Rocm90dGxlcyhmbi5mdW5jdGlvbk5hbWUpO1xuICAgIGNvbnN0IHRocm90dGxlc0FsYXJtID0gdGhyb3R0bGVzTWV0cmljLmNyZWF0ZUFsYXJtKHRoaXMsICdUaHJvdHRsZXNBbGFybScsIHtcbiAgICAgIGFsYXJtRGVzY3JpcHRpb246IGBPdmVyICR7dGhyb3R0bGVzUGVyTWludXRlVGhyZXNob2xkfSB0aHJvdHRsZXMgcGVyIG1pbnV0ZWAsXG4gICAgICB0aHJlc2hvbGQ6IHRocm90dGxlc1Blck1pbnV0ZVRocmVzaG9sZCxcbiAgICAgIGNvbXBhcmlzb25PcGVyYXRvcjogY2xvdWR3YXRjaC5Db21wYXJpc29uT3BlcmF0b3IuR1JFQVRFUl9USEFOX1RIUkVTSE9MRCxcbiAgICAgIGV2YWx1YXRpb25QZXJpb2RzLFxuICAgIH0pO1xuICAgIHRoaXMud2F0Y2hmdWwuYWRkQWxhcm0odGhyb3R0bGVzQWxhcm0pO1xuICAgIHJldHVybiB7IHRocm90dGxlc01ldHJpYywgdGhyb3R0bGVzQWxhcm0gfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRHVyYXRpb25Nb25pdG9yKFxuICAgIHRpbWVvdXRTZWM6IG51bWJlcixcbiAgICBkdXJhdGlvblBlcmNlbnRUaHJlc2hvbGQ6IG51bWJlciA9IERFRkFVTFRfRFVSQVRJT05fVEhSRVNIT0xEX1BFUkNFTlQsXG4gICAgZXZhbHVhdGlvblBlcmlvZHMgPSAzLFxuICApIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZm47XG4gICAgY29uc3QgZHVyYXRpb25NZXRyaWMgPSB0aGlzLm1ldHJpY3MubWV0cmljRHVyYXRpb24oZm4uZnVuY3Rpb25OYW1lKS5wOTk7XG4gICAgY29uc3QgZHVyYXRpb25UaHJlc2hvbGRTZWMgPSBNYXRoLmZsb29yKFxuICAgICAgKGR1cmF0aW9uUGVyY2VudFRocmVzaG9sZCAvIDEwMCkgKiB0aW1lb3V0U2VjLFxuICAgICk7XG4gICAgY29uc3QgZHVyYXRpb25BbGFybSA9IGR1cmF0aW9uTWV0cmljLmNyZWF0ZUFsYXJtKHRoaXMsICdEdXJhdGlvbkFsYXJtJywge1xuICAgICAgYWxhcm1EZXNjcmlwdGlvbjogYHA5OSBsYXRlbmN5ID49ICR7ZHVyYXRpb25UaHJlc2hvbGRTZWN9cyAoJHtkdXJhdGlvblBlcmNlbnRUaHJlc2hvbGR9JSlgLFxuICAgICAgY29tcGFyaXNvbk9wZXJhdG9yOiBjbG91ZHdhdGNoLkNvbXBhcmlzb25PcGVyYXRvci5HUkVBVEVSX1RIQU5fVEhSRVNIT0xELFxuICAgICAgdGhyZXNob2xkOiBkdXJhdGlvblRocmVzaG9sZFNlYyAqIDEwMDAsIC8vIG1pbGxpc2Vjb25kc1xuICAgICAgZXZhbHVhdGlvblBlcmlvZHMsXG4gICAgfSk7XG4gICAgdGhpcy53YXRjaGZ1bC5hZGRBbGFybShkdXJhdGlvbkFsYXJtKTtcbiAgICByZXR1cm4geyBkdXJhdGlvbk1ldHJpYywgZHVyYXRpb25BbGFybSB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGxpbmtGb3JMYW1iZGFGdW5jdGlvbihmbjogbGFtYmRhLkZ1bmN0aW9uLCB0YWIgPSAnZ3JhcGgnKSB7XG4gIHJldHVybiBgaHR0cHM6Ly9jb25zb2xlLmF3cy5hbWF6b24uY29tL2xhbWJkYS9ob21lP3JlZ2lvbj0ke2ZuLnN0YWNrLnJlZ2lvbn0jL2Z1bmN0aW9ucy8ke2ZuLmZ1bmN0aW9uTmFtZX0/dGFiPSR7dGFifWA7XG59XG5cbmZ1bmN0aW9uIGxpbmtGb3JMYW1iZGFMb2dzKGZuOiBsYW1iZGEuRnVuY3Rpb24pIHtcbiAgcmV0dXJuIGBodHRwczovL2NvbnNvbGUuYXdzLmFtYXpvbi5jb20vY2xvdWR3YXRjaC9ob21lP3JlZ2lvbj0ke2ZuLnN0YWNrLnJlZ2lvbn0jbG9nRXZlbnRWaWV3ZXI6Z3JvdXA9L2F3cy9sYW1iZGEvJHtmbi5mdW5jdGlvbk5hbWV9YDtcbn1cbiJdfQ==